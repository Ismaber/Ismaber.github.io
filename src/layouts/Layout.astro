---
// src/layouts/Base.astro
import '../styles/global.css'
import Background from "../components/Background.astro";
import { t } from '../i18n/store.ts';
import Snake from '../components/Snake.astro';
import { IDS } from '../constants/game';

type Props = {
  title?: string;
  description?: string;
  image?: string;         // ruta absoluta o relativa a /public
  noindex?: boolean;      // opcional para desindexar páginas concretas
}

const locale = (Astro.currentLocale ?? 'es') as 'es' | 'en';
const pageTitleDefault = t(locale, 'title');

const {
  title = pageTitleDefault,
  description = t(locale, 'meta.description') ?? '',
  image = '/og-default.jpg',
  noindex = false
} = Astro.props as Props;

const canonical = Astro.url;

// Hreflang: ajusta tus rutas reales (ej. /en/... para inglés)
const path = Astro.url.pathname;
let altEs: string;
let altEn: string;

if (path === '/' || path === '') {
  altEs = '/es/';
  altEn = '/en/';
} else if (path === '/es' || path.startsWith('/es/')) {
  altEs = path.endsWith('/') ? path : path + '/';
  altEn = altEs.replace(/^\/es\//, '/en/').replace(/^\/es$/, '/en');
} else if (path === '/en' || path.startsWith('/en/')) {
  altEn = path.endsWith('/') ? path : path + '/';
  altEs = altEn.replace(/^\/en\//, '/es/').replace(/^\/en$/, '/es');
} else {
  altEs = '/es/';
  altEn = '/en/';
}

const siteName = t(locale, 'siteName') ?? 'Mi Portfolio';
const twitterHandle = null;
const ogImage = image.startsWith('http') ? image : new URL(image, Astro.site).href;

const robotsContent = noindex ? 'noindex, nofollow' : 'index, follow';
---

<!doctype html>
<html lang={locale} class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <meta name="color-scheme" content="dark light" />
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)"  content="#0b1020" />

    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="robots" content={robotsContent} />
		<link rel="sitemap" href="/sitemap-index.xml" />
    <link rel="canonical" href={canonical.href} />

    <!-- i18n / hreflang -->
    <link rel="alternate" href={new URL(altEs, Astro.site).href} hreflang="es" />
    <link rel="alternate" href={new URL(altEn, Astro.site).href} hreflang="en" />
    <link rel="alternate" href={canonical.href} hreflang="x-default" />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonical.href} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:locale" content={locale === 'es' ? 'es_ES' : 'en_US'} />
    <meta property="og:locale:alternate" content={locale === 'es' ? 'en_US' : 'es_ES'} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    {twitterHandle && <meta name="twitter:site" content={twitterHandle} />}
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />

    <meta name="google-site-verification" content="hn6qG79Az5NpSqvinakDA0-DG9GszeVGJBiOUbQm1dQ" />

    <!-- JSON-LD: Person + WebSite + WebPage (ajusta datos) -->
    <script type="application/ld+json">
      {JSON.stringify({
        "@context": "https://schema.org",
        "@graph": [
          // PERSONA (autor del sitio)
          {
            "@type": "Person",
            "@id": new URL('#me', Astro.site).href,
            "name": "Tu Nombre",
            "url": Astro.site,
            "sameAs": [
              "https://github.com/Ismaber",
              "https://www.linkedin.com/in/ismael-berdusán-muñoz-a72a41338/"
            ]
          },

          // SITIO WEB
          {
            "@type": "WebSite",
            "@id": new URL('#website', Astro.site).href,
            "url": Astro.site,
            "name": siteName,
            "inLanguage": locale
          },

          // PÁGINA ACTUAL
          {
            "@type": "WebPage",
            "@id": canonical.href + '#webpage',
            "url": canonical.href,
            "name": title,
            "isPartOf": { "@id": new URL('#website', Astro.site).href },
            "about": { "@id": new URL('#me', Astro.site).href },
            "description": description,
            "image": ogImage,
            "inLanguage": locale
          }
        ]
      })}
    </script>

    <!-- Tema al primer paint -->
    <script is:inline>
      (() => {
        try {
          const stored = localStorage.getItem('theme');
          const prefersDark = matchMedia('(prefers-color-scheme: dark)').matches;
          let theme = stored || (prefersDark ? 'indigo-dark' : 'indigo');
          const root = document.documentElement;
          root.classList.add(theme);
          root.setAttribute('data-theme', theme);
          if (theme.endsWith('-dark')) {
            root.classList.add('dark');
            root.style.colorScheme = 'dark';
          } else {
            root.style.colorScheme = 'light';
          }
        } catch {}
      })();
    </script>
  </head>
  <body>
    <Background/>
    <slot id={IDS.pageShell}/>
    <Snake/>
  </body>
</html>
